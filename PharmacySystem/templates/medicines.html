{% extends 'main.html' %}

{% load static %}

{% block content %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medicines - Smart Pharmacy Management System</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>

<body>
    <div class="dashboard-container">

        <main class="main-content">
            <div class="page-header">
                <h1>Medicines Inventory</h1>
                <p>Manage your pharmaceutical inventory</p>
            </div>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
            {% endif %}

            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">All Medicines</h2>
                    <div class="table-actions">
                        <form method="GET" action="" style="display: flex; gap: 10px;">
                            <input type="text" name="search" class="search-box" placeholder="Search by name or code..."
                                value="{{ request.GET.search }}">
                        </form>
                        <button class="btn-add" onclick="openAddMedicineModal()">+ Add Medicine</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Medicine Name</th>
                            <th>Code</th>
                            <th>Category</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for medicine in all_medicines %}
                        <tr>
                            <td>{{ medicine.Name }}</td>
                            <td>{{ medicine.Code }}</td>
                            <td>{{ medicine.Category }}</td>
                            <td>{{ medicine.Quantity }}</td>
                            <td>${{ medicine.Price }}</td>
                            <td>
                                {% if medicine.Quantity < medicine.MinStock %} <span class="status-badge status-low">Low
                                    Stock</span>
                                    {% else %}
                                    <span class="status-badge status-active">In Stock</span>
                                    {% endif %}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <a href="javascript:void(0)" class="btn-edit"
                                        data-url="{% url 'edit_medicine' medicine.Number %}"
                                        data-name="{{ medicine.Name }}" data-code="{{ medicine.Code }}"
                                        data-category="{{ medicine.Category }}" data-quantity="{{ medicine.Quantity }}"
                                        data-minstock="{{ medicine.MinStock }}" data-price="{{ medicine.Price }}"
                                        data-expiry="{{ medicine.Expiry|date:'Y-m-d' }}"
                                        onclick="openEditMedicineModal(this)">Edit</a>
                                    <a href="{% url 'delete_medicine' medicine.Number %}" class="btn-delete"
                                        onclick="return confirm('Are you sure you want to delete this medicine?');"
                                        style="text-decoration: none; display: inline-block; line-height: normal;">
                                        Delete
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="7" class="no-data">No medicines added yet. Click "Add Medicine" to get started.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <div id="medicineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add New Medicine</h2>
                <button class="close-btn" onclick="closeMedicineModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="medicineForm" method="POST" action="{% url 'medicines' %}" enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="form-group">
                        <label>Medicine Name</label>
                        <input type="text" name="name" id="medicineName" required placeholder="e.g., Aspirin">
                    </div>

                    <div class="form-group">
                        <label>Medicine Code</label>
                        <input type="text" name="code" id="medicineCode" required placeholder="e.g., ASP-001">
                    </div>

                    <div class="form-group">
                        <label>Select Category</label>
                        <select name="category" id="medicineCategory" required 
                            style="width: 100%; padding: 12px; background-color: #0a0a0a; border: 1px solid #2a2a2a; border-radius: 6px; color: #eeeeee; font-size: 14px;">
                            <option value="">-- Select a category --</option>
                            {% for value, label in cat_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" name="quantity" id="medicineQuantity" required min="0" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>Minimum Stock Level</label>
                        <input type="number" name="min_stock" id="medicineMinStock" required min="0" placeholder="0">
                    </div>

                    <div class="form-group">
                        <label>Unit Price ($)</label>
                        <input type="number" name="price" id="medicinePrice" required min="0" step="0.01"
                            placeholder="0.00">
                    </div>

                    <div class="form-group">
                        <label>Expiry Date</label>
                        <input type="date" name="expiry" id="medicineExpiry" required>
                    </div>

                    <hr style="border: 0; border-top: 1px solid #333; margin: 15px 0;">
                    <h4 style="color: #888; margin-bottom: 10px;">Additional Details</h4>

                    <div class="form-group">
                        <label>Scientific Description</label>
                        <textarea name="description" rows="2" style="width: 100%; padding: 10px; background-color: #0a0a0a; border: 1px solid #2a2a2a; border-radius: 6px; color: #eee;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Side Effects</label>
                        <textarea name="side_effects" rows="2" style="width: 100%; padding: 10px; background-color: #0a0a0a; border: 1px solid #2a2a2a; border-radius: 6px; color: #eee;"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Medicine Image (Box Shape)</label>
                        <input type="file" name="box_shape" style="color: #eee;">
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" onclick="closeMedicineModal()">Cancel</button>
                        <button type="submit" class="btn-submit" id="submitBtn">Save Medicine</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'script.js' %}"></script>

    <script>
        function openAddMedicineModal() {
            document.getElementById('medicineModal').classList.add('show');
            document.getElementById('medicineForm').action = "{% url 'medicines' %}";
            document.getElementById('modalTitle').innerText = "Add New Medicine";
            document.getElementById('submitBtn').innerText = "Save Medicine";
            document.getElementById('medicineForm').reset();
        }

        function openEditMedicineModal(element) {
            document.getElementById('medicineModal').classList.add('show');
            document.getElementById('medicineForm').action = element.dataset.url;
            document.getElementById('modalTitle').innerText = "Edit Medicine";
            document.getElementById('submitBtn').innerText = "Save Medicine";

            document.getElementById('medicineName').value = element.dataset.name;
            document.getElementById('medicineCode').value = element.dataset.code;
            document.getElementById('medicineCategory').value = element.dataset.category;
            document.getElementById('medicineQuantity').value = element.dataset.quantity;
            document.getElementById('medicineMinStock').value = element.dataset.minstock;
            document.getElementById('medicinePrice').value = element.dataset.price;
            document.getElementById('medicineExpiry').value = element.dataset.expiry;
        }

        function closeMedicineModal() {
            document.getElementById('medicineModal').classList.remove('show');
        }
    </script>

</body>

</html>

{% endblock %}