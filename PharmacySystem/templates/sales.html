{% extends 'main.html' %}

{% load static %}

{% block content %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales - Smart Pharmacy Management System</title>
    <link rel="stylesheet" href="{% static 'style.css' %}">
</head>

<body>
    <div class="dashboard-container">

        <main class="main-content">
            <div class="page-header">
                <h1>Sales Transactions</h1>
                <p>Track and manage all sales records</p>
            </div>

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
            {% endif %}

            <!-- Sales Table -->
            <div class="table-container">
                <div class="table-header">
                    <h2 class="table-title">Recent Sales</h2>
                    <div class="table-actions">
                        <form method="GET" action="" style="display: flex; gap: 10px;">
                            <input type="text" name="search" class="search-box" placeholder="Search by medicine name..."
                                value="{{ request.GET.search }}">
                        </form>
                        <button class="btn-add" onclick="openAddSaleModal()">+ Record Sale</button>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Transaction ID</th>
                            <th>Medicine Name</th>
                            <th>Quantity Sold</th>
                            <th>Unit Price</th>
                            <th>Total Amount</th>
                            <th>Date</th>
                            <th>Customer</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salesTableBody">
                        {% for a in all_sales %}
                        <tr>
                            <td>{{ a.Number }}</td>
                            <td>{{ a.medicine.Name }}</td>
                            <td>{{ a.Sold }}</td>
                            <td>${{ a.Unit_Price }}</td>
                            <td>${{ a.Total }}</td>
                            <td>{{ a.Date }}</td>
                            <td>{{ a.Customer }}</td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{% url 'delete_sale' a.Number %}" class="btn-delete"
                                        onclick="return confirm('Are you sure you want to delete this sale record?');"
                                        style="text-decoration: none; display: inline-block; line-height: normal;">
                                        Delete
                                    </a>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="no-data">No sales recorded yet. Click "Record Sale" to add a transaction.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal for Adding/Editing Sale -->
    <div id="saleModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Record New Sale</h2>
                <button class="close-btn" onclick="closeSaleModal()">&times;</button>
            </div>

            <div class="modal-body">
                <form id="saleForm" method="POST" action="{% url 'add_sale' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>Select Medicine</label>
                        <select name="medicine_id" id="saleMedicine" required
                            style="width: 100%; padding: 12px; background-color: #0a0a0a; border: 1px solid #2a2a2a; border-radius: 6px; color: #eeeeee; font-size: 14px;">
                            <option value="">-- Select a medicine --</option>
                            {% for med in all_medicines %}
                            <option value="{{ med.Number }}" data-price="{{ med.Price }}"
                                data-quantity="{{ med.Quantity }}">
                                {{ med.Name }} (Stock: {{ med.Quantity }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Quantity Sold</label>
                        <input type="number" name="Sold" id="saleQuantity" placeholder="0" min="1" required>
                    </div>

                    <div class="form-group">
                        <label>Unit Price ($)</label>
                        <input type="number" name="Unit_Price" id="saleUnitPrice" placeholder="0.00" min="0" step="0.01"
                            readonly>
                    </div>

                    <div class="form-group">
                        <label>Total Amount ($)</label>
                        <input type="number" name="Total" id="saleTotalAmount" placeholder="0.00" readonly>
                    </div>

                    <div class="form-group">
                        <label>Customer Name</label>
                        <input type="text" name="Customer" id="saleCustomer" placeholder="e.g., John Doe" required>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn-cancel" onclick="closeSaleModal()">Cancel</button>
                        <button type="submit" class="btn-submit" id="submitBtn">Record Sale</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{% static 'script.js' %}"></script>
    <script>
        // Update price and total when medicine or quantity changes
        document.getElementById('saleMedicine').addEventListener('change', updatePrice);
        document.getElementById('saleQuantity').addEventListener('input', updateTotal);

        function updatePrice() {
            const select = document.getElementById('saleMedicine');
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.dataset.price || 0;
            document.getElementById('saleUnitPrice').value = price;
            updateTotal();
        }

        function updateTotal() {
            const quantity = document.getElementById('saleQuantity').value || 0;
            const price = document.getElementById('saleUnitPrice').value || 0;
            document.getElementById('saleTotalAmount').value = (quantity * price).toFixed(2);
        }

        function openAddSaleModal() {
            document.getElementById('saleModal').classList.add('show');
            document.getElementById('saleForm').action = "{% url 'add_sale' %}";
            document.getElementById('modalTitle').innerText = "Record New Sale";
            document.getElementById('submitBtn').innerText = "Record Sale";
            document.getElementById('saleForm').reset();
            document.getElementById('saleUnitPrice').value = '';
            document.getElementById('saleTotalAmount').value = '';
        }

        function closeSaleModal() {
            document.getElementById('saleModal').classList.remove('show');
        }
    </script>
</body>

</html>

{% endblock %}